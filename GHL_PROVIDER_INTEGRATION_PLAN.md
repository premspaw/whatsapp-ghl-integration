# GHL Marketplace Conversation Provider Integration Plan

## Current Understanding

You are building a **GHL Marketplace App** that acts as a **Conversation Provider**. This means:

1. **Any GHL sub-account** can install your app from the marketplace
2. **Conversations flow through GHL** (not directly to your server)
3. **Your server acts as the backend** for the Conversation Provider
4. **AI processes messages** and replies through GHL's conversation system

## Correct Message Flow

```
┌─────────────┐
│  WhatsApp   │
│   Contact   │
└──────┬──────┘
       │ Message
       ▼
┌─────────────────────────────────────┐
│  GHL LeadConnector Conversation     │
│  (Your Conversation Provider)       │
└──────┬──────────────────────────────┘
       │ Webhook: Outbound Message
       ▼
┌─────────────────────────────────────┐
│  Your Server (Tachyon Radiation)    │
│  - Receives webhook from GHL        │
│  - AI processes the message         │
│  - Generates response               │
└──────┬──────────────────────────────┘
       │ API Call: Inbound Message
       ▼
┌─────────────────────────────────────┐
│  GHL Conversations API              │
│  POST /conversations/messages/      │
│       inbound                       │
└──────┬──────────────────────────────┘
       │ Message appears in GHL
       ▼
┌─────────────────────────────────────┐
│  WhatsApp Contact                   │
│  (Receives AI reply)                │
└─────────────────────────────────────┘
```

## Required Configuration

### 1. Environment Variables Needed

```env
# GHL OAuth (Already configured)
GHL_OAUTH_CLIENT_ID=68ec93c80aad6bbd8249e3e2-minl7lu9
GHL_OAUTH_CLIENT_SECRET=9c8347ad-0833-4221-85e0-f6c961276a27
GHL_OAUTH_REDIRECT_URI=https://YOUR-VPS-URL/api/oauth/callback
GHL_OAUTH_VERSION_ID=692dde2c13a71a9413fae79f

# MISSING: Conversation Provider ID
CONVERSATION_PROVIDER_ID=<YOUR_PROVIDER_ID>

# VPS URL (for webhooks and OAuth)
BASE_URL=https://YOUR-VPS-URL
APP_URL=https://YOUR-VPS-URL
```

### 2. GHL Marketplace App Configuration

In your GHL Marketplace App settings, you need to configure:

#### OAuth Settings
- **Redirect URI**: `https://YOUR-VPS-URL/api/oauth/callback`
- **Scopes**: 
  - `conversations.readonly`
  - `conversations.write`
  - `conversations/message.readonly`
  - `conversations/message.write`
  - `contacts.readonly`
  - `contacts.write`

#### Conversation Provider Settings
- **Provider ID**: (This is generated by GHL when you create the provider)
- **Outbound Webhook URL**: `https://YOUR-VPS-URL/provider/outbound`
- **Message Types**: SMS, WhatsApp (if supported)

### 3. Required Endpoints (Already Implemented)

✅ **OAuth Endpoints**:
- `GET /api/oauth/authorize` - Start OAuth flow
- `GET /api/oauth/callback` - Handle OAuth callback
- `POST /api/oauth/refresh` - Refresh tokens

✅ **Provider Endpoints**:
- `POST /provider/outbound` - Receive messages FROM GHL
- `POST /api/ghl/inbound` - Send messages TO GHL

## Implementation Checklist

### Phase 1: Configuration ✅ (Mostly Done)
- [x] OAuth credentials configured
- [x] OAuth routes implemented
- [x] Provider routes implemented
- [ ] **MISSING**: `CONVERSATION_PROVIDER_ID` in .env
- [ ] **MISSING**: VPS URL configured

### Phase 2: Message Handling ✅ (Already Implemented)
- [x] Receive outbound messages from GHL (`/provider/outbound`)
- [x] Process with AI
- [x] Send inbound messages to GHL (`/api/ghl/inbound`)
- [x] Token management (OAuth)

### Phase 3: Testing & Deployment
- [ ] Deploy to VPS
- [ ] Update GHL Marketplace App with VPS URLs
- [ ] Test OAuth flow
- [ ] Test message flow: GHL → Server → AI → GHL
- [ ] Install app in a test sub-account
- [ ] Verify conversations appear in LeadConnector

## What I Need From You

1. **Conversation Provider ID**: 
   - Go to your GHL Marketplace App settings
   - Find the "Conversation Provider" section
   - Copy the Provider ID

2. **VPS URL**: 
   - What is your VPS domain/IP?
   - Example: `https://api.yourdomain.com` or `https://123.45.67.89`

3. **Confirmation**:
   - Is the app already published in GHL Marketplace?
   - Or is it still in development/testing mode?

Once you provide these, I'll update the configuration and ensure everything is properly connected.
