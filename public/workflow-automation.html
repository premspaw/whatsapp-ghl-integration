<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp-GHL Workflow Automation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .workflow-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .workflow-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .node {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .node:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.2);
        }
        .node.connected {
            border-color: #28a745;
            background: #d4edda;
        }
        .node.selected {
            border-color: #007bff;
            background: #e3f2fd;
        }
        .connection-line {
            position: absolute;
            height: 2px;
            background: #007bff;
            z-index: 1;
        }
        .workflow-canvas {
            min-height: 500px;
            background: #f8f9fa;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        .node-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        .node-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .node-description {
            font-size: 12px;
            color: #6c757d;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .status-connected { background: #28a745; }
        .status-disconnected { background: #dc3545; }
        .status-pending { background: #ffc107; }
    </style>
</head>
<body>
    <div class="workflow-container">
        <div class="container-fluid">
            <!-- Header -->
            <div class="row">
                <div class="col-12">
                    <div class="workflow-card">
                        <div class="p-4">
                            <h2 class="mb-0">
                                <i class="fas fa-project-diagram text-primary"></i>
                                WhatsApp-GHL Workflow Automation
                            </h2>
                            <p class="text-muted mb-0">Connect WhatsApp Business API → AI Agent → GHL CRM</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Workflow Interface -->
            <div class="row">
                <!-- Left Sidebar - Node Library -->
                <div class="col-md-3">
                    <div class="workflow-card">
                        <div class="p-3">
                            <h5><i class="fas fa-puzzle-piece"></i> Workflow Nodes</h5>
                            
                            <!-- WhatsApp Business API Node -->
                            <div class="node" data-node-type="whatsapp-api">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-comments node-icon text-success"></i>
                                    <div>
                                        <div class="node-title">WhatsApp Business API</div>
                                        <div class="node-description">Meta Cloud Integration</div>
                                    </div>
                                </div>
                                <div class="status-indicator status-disconnected"></div>
                            </div>

                            <!-- AI Agent Node -->
                            <div class="node" data-node-type="ai-agent">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-robot node-icon text-warning"></i>
                                    <div>
                                        <div class="node-title">AI Agent</div>
                                        <div class="node-description">Trainable AI Responses</div>
                                    </div>
                                </div>
                                <div class="status-indicator status-disconnected"></div>
                            </div>

                            <!-- GHL CRM Node -->
                            <div class="node" data-node-type="ghl-crm">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-database node-icon text-info"></i>
                                    <div>
                                        <div class="node-title">GHL CRM</div>
                                        <div class="node-description">All CRM Features</div>
                                    </div>
                                </div>
                                <div class="status-indicator status-disconnected"></div>
                            </div>

                            <!-- Website Form Node -->
                            <div class="node" data-node-type="website-form">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-wpforms node-icon text-primary"></i>
                                    <div>
                                        <div class="node-title">Website Form</div>
                                        <div class="node-description">AI Training Data</div>
                                    </div>
                                </div>
                                <div class="status-indicator status-disconnected"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Connection Status -->
                    <div class="workflow-card">
                        <div class="p-3">
                            <h5><i class="fas fa-link"></i> Connection Status</h5>
                            <div class="mb-2">
                                <span class="badge bg-success">WhatsApp API</span>
                                <small class="text-muted d-block">Connected to Meta Cloud</small>
                            </div>
                            <div class="mb-2">
                                <span class="badge bg-warning">AI Agent</span>
                                <small class="text-muted d-block">Training in progress</small>
                            </div>
                            <div class="mb-2">
                                <span class="badge bg-info">GHL CRM</span>
                                <small class="text-muted d-block">All features active</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Workflow Canvas -->
                <div class="col-md-9">
                    <div class="workflow-card">
                        <div class="p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="fas fa-sitemap"></i> Workflow Canvas</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="clearWorkflow()">
                                        <i class="fas fa-trash"></i> Clear
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="saveWorkflow()">
                                        <i class="fas fa-save"></i> Save Workflow
                                    </button>
                                </div>
                            </div>
                            
                            <div class="workflow-canvas" id="workflowCanvas">
                                <!-- Workflow nodes will be added here -->
                                <div class="text-center text-muted mt-5">
                                    <i class="fas fa-mouse-pointer fa-3x mb-3"></i>
                                    <p>Drag nodes from the sidebar to create your workflow</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Training Section -->
            <div class="row">
                <div class="col-12">
                    <div class="workflow-card">
                        <div class="p-3">
                            <h5><i class="fas fa-graduation-cap"></i> AI Agent Training</h5>
                            <p class="text-muted">Train your AI agent through website forms and Q&A data</p>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Website Form Integration</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Website URL</label>
                                        <input type="url" class="form-control" id="websiteUrl" placeholder="https://yourwebsite.com">
                                    </div>
                                    <button class="btn btn-primary" onclick="generateFormCode()">
                                        <i class="fas fa-code"></i> Generate Form Code
                                    </button>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6>Q&A Training Data</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Question</label>
                                        <input type="text" class="form-control" id="trainingQuestion" placeholder="What are your business hours?">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Answer</label>
                                        <textarea class="form-control" id="trainingAnswer" rows="3" placeholder="Our business hours are Monday to Friday, 9 AM to 5 PM."></textarea>
                                    </div>
                                    <button class="btn btn-success" onclick="addTrainingData()">
                                        <i class="fas fa-plus"></i> Add Training Data
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Generated Form Code -->
                            <div id="formCodeSection" style="display: none;">
                                <h6>Generated Form Code</h6>
                                <textarea class="form-control" id="generatedFormCode" rows="5" readonly></textarea>
                                <small class="text-muted">Add this code to your website to collect training data</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedNode = null;
        let workflowNodes = [];
        let connections = [];

        // Initialize workflow canvas
        document.addEventListener('DOMContentLoaded', function() {
            initializeWorkflowCanvas();
            loadWorkflowStatus();
        });

        function initializeWorkflowCanvas() {
            const canvas = document.getElementById('workflowCanvas');
            
            // Make nodes draggable
            document.querySelectorAll('.node').forEach(node => {
                node.addEventListener('dragstart', handleDragStart);
                node.addEventListener('dragend', handleDragEnd);
                node.draggable = true;
            });

            // Canvas click handler
            canvas.addEventListener('click', function(e) {
                if (e.target === canvas) {
                    clearSelection();
                }
            });
        }

        function handleDragStart(e) {
            selectedNode = e.target;
            e.target.style.opacity = '0.5';
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            
            const canvas = document.getElementById('workflowCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (x >= 0 && x <= rect.width && y >= 0 && y <= rect.height) {
                addNodeToCanvas(selectedNode, x, y);
            }
        }

        function addNodeToCanvas(nodeTemplate, x, y) {
            const nodeType = nodeTemplate.getAttribute('data-node-type');
            const nodeId = 'node_' + Date.now();
            
            const newNode = document.createElement('div');
            newNode.className = 'node';
            newNode.id = nodeId;
            newNode.style.position = 'absolute';
            newNode.style.left = x + 'px';
            newNode.style.top = y + 'px';
            newNode.style.width = '200px';
            newNode.innerHTML = nodeTemplate.innerHTML;
            
            // Add click handler
            newNode.addEventListener('click', function(e) {
                e.stopPropagation();
                selectNode(newNode);
            });
            
            document.getElementById('workflowCanvas').appendChild(newNode);
            
            // Store node data
            workflowNodes.push({
                id: nodeId,
                type: nodeType,
                x: x,
                y: y,
                status: 'disconnected'
            });
            
            // Clear the placeholder text
            const canvas = document.getElementById('workflowCanvas');
            const placeholder = canvas.querySelector('.text-center');
            if (placeholder) {
                placeholder.remove();
            }
        }

        function selectNode(node) {
            clearSelection();
            node.classList.add('selected');
            selectedNode = node;
        }

        function clearSelection() {
            document.querySelectorAll('.node').forEach(node => {
                node.classList.remove('selected');
            });
            selectedNode = null;
        }

        function clearWorkflow() {
            document.getElementById('workflowCanvas').innerHTML = `
                <div class="text-center text-muted mt-5">
                    <i class="fas fa-mouse-pointer fa-3x mb-3"></i>
                    <p>Drag nodes from the sidebar to create your workflow</p>
                </div>
            `;
            workflowNodes = [];
            connections = [];
        }

        function saveWorkflow() {
            const workflow = {
                nodes: workflowNodes,
                connections: connections,
                timestamp: new Date().toISOString()
            };
            
            // Save to localStorage for demo
            localStorage.setItem('whatsapp-ghl-workflow', JSON.stringify(workflow));
            
            // Send to server
            fetch('/api/workflow/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(workflow)
            })
            .then(response => response.json())
            .then(data => {
                alert('Workflow saved successfully!');
            })
            .catch(error => {
                console.error('Error saving workflow:', error);
                alert('Error saving workflow');
            });
        }

        function loadWorkflowStatus() {
            // Load connection status
            fetch('/api/workflow/status')
            .then(response => response.json())
            .then(data => {
                updateConnectionStatus(data);
            })
            .catch(error => {
                console.error('Error loading status:', error);
            });
        }

        function updateConnectionStatus(status) {
            // Update status indicators
            Object.keys(status).forEach(service => {
                const indicator = document.querySelector(`[data-service="${service}"] .status-indicator`);
                if (indicator) {
                    indicator.className = `status-indicator status-${status[service]}`;
                }
            });
        }

        function generateFormCode() {
            const websiteUrl = document.getElementById('websiteUrl').value;
            if (!websiteUrl) {
                alert('Please enter your website URL');
                return;
            }
            
            const formCode = `<!-- AI Training Form -->
<form id="ai-training-form" action="${window.location.origin}/api/ai/train" method="POST">
    <div class="mb-3">
        <label for="question" class="form-label">Question</label>
        <input type="text" class="form-control" id="question" name="question" required>
    </div>
    <div class="mb-3">
        <label for="answer" class="form-label">Answer</label>
        <textarea class="form-control" id="answer" name="answer" rows="3" required></textarea>
    </div>
    <button type="submit" class="btn btn-primary">Train AI Agent</button>
</form>

<script>
document.getElementById('ai-training-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('${window.location.origin}/api/ai/train', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        alert('AI training data submitted successfully!');
        this.reset();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error submitting training data');
    });
});
</script>`;
            
            document.getElementById('generatedFormCode').value = formCode;
            document.getElementById('formCodeSection').style.display = 'block';
        }

        function addTrainingData() {
            const question = document.getElementById('trainingQuestion').value;
            const answer = document.getElementById('trainingAnswer').value;
            
            if (!question || !answer) {
                alert('Please fill in both question and answer');
                return;
            }
            
            const trainingData = {
                question: question,
                answer: answer,
                timestamp: new Date().toISOString()
            };
            
            fetch('/api/ai/train', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(trainingData)
            })
            .then(response => response.json())
            .then(data => {
                alert('Training data added successfully!');
                document.getElementById('trainingQuestion').value = '';
                document.getElementById('trainingAnswer').value = '';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding training data');
            });
        }
    </script>
</body>
</html>
