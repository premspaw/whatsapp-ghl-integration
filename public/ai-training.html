<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Management</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: #f8fafc; 
      color: #334155; 
      margin: 0; 
    }
    header { 
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%); 
      color: #fff; 
      padding: 1rem 1.5rem; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
    }
    h1 { font-size: 1.25rem; margin: 0; }
    main { max-width: 800px; margin: 1.5rem auto; padding: 0 1rem; }
    .section { 
      background: #fff; 
      border: 1px solid #e2e8f0; 
      border-radius: 12px; 
      padding: 1.5rem; 
      margin-bottom: 1.5rem; 
    }
    .section h2 { 
      font-size: 1.1rem; 
      margin-bottom: 1rem; 
      color: #1e293b;
    }
    .form-row { 
      display: flex; 
      gap: 0.5rem; 
      align-items: center; 
      margin-bottom: 1rem; 
    }
    label { 
      width: 180px; 
      font-weight: 600; 
      color: #475569;
    }
    input, select, textarea { 
      flex: 1; 
      padding: 0.75rem; 
      border: 1px solid #d1d5db; 
      border-radius: 8px; 
      font-size: 0.95rem; 
    }
    .btn { 
      background: #334155; 
      color: #fff; 
      border: none; 
      padding: 0.75rem 1.25rem; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: 600;
    }
    .btn:hover { background: #1e293b; }
    .btn.secondary { background: #64748b; }
    .btn.success { background: #059669; }
    .btn.danger { background: #dc2626; }
    .alert { 
      padding: 0.75rem 1rem; 
      margin-top: 1rem; 
      border-radius: 8px; 
      font-weight: 500;
    }
    .alert.info { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; }
    .alert.success { background: #ecfdf5; border: 1px solid #a7f3d0; color: #065f46; }
    .alert.error { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; }
    .flex { display: flex; gap: 0.75rem; align-items: center; }
    .toggle-container { 
      display: flex; 
      align-items: center; 
      gap: 1rem; 
      padding: 1rem; 
      background: #f1f5f9; 
      border-radius: 8px; 
      margin-bottom: 1rem;
    }
    .toggle { 
      position: relative; 
      width: 60px; 
      height: 30px; 
      background: #cbd5e1; 
      border-radius: 15px; 
      cursor: pointer; 
      transition: background 0.3s;
    }
    .toggle.active { background: #059669; }
    .toggle-slider { 
      position: absolute; 
      top: 3px; 
      left: 3px; 
      width: 24px; 
      height: 24px; 
      background: white; 
      border-radius: 50%; 
      transition: transform 0.3s;
    }
    .toggle.active .toggle-slider { transform: translateX(30px); }
    .status-text { 
      font-weight: 600; 
      font-size: 1.1rem;
    }
    .status-text.active { color: #059669; }
    .status-text.inactive { color: #dc2626; }
  </style>
</head>
<body>
  <header>
    <h1>ü§ñ AI Management</h1>
    <div class="flex">
      <a href="/ghl-whatsapp-tab.html" class="btn secondary">Back to GHL Tab</a>
    </div>
  </header>
  
  <main>
    <!-- AI Control (Personality-based) -->
    <div class="section">
      <h2>üîß AI Control</h2>
      <div class="toggle-container">
        <div class="toggle" id="aiToggle" onclick="toggleAI()">
          <div class="toggle-slider"></div>
        </div>
        <div class="status-text" id="aiStatus">AI is Active</div>
      </div>
      <div id="aiToggleStatus" class="alert info" style="display:none"></div>
      <div class="flex">
        <a href="/ai-n8n.html" class="btn secondary">Open AI via n8n</a>
      </div>
    </div>

    <!-- Personality & Brand Editing -->
    <div class="section">
      <h2>üé≠ AI Personality & üè∑Ô∏è Brand</h2>
      <div class="alert info">These fields update a single personality profile used for all AI replies. No duplication.</div>
      <div class="form-row"><label for="name">Assistant Name</label><input id="name" placeholder="e.g., Sarah" /></div>
      <div class="form-row"><label for="role">Role</label><input id="role" placeholder="e.g., Customer Success Manager" /></div>
      <div class="form-row"><label for="company">Company</label><input id="company" placeholder="e.g., SYNTHCORE" /></div>
      <div class="form-row"><label for="website">Website</label><input id="website" placeholder="https://example.com" /></div>
      <div class="form-row"><label for="supportEmail">Support Email</label><input id="supportEmail" placeholder="support@example.com" /></div>
      <div class="form-row"><label for="supportPhone">Support Phone</label><input id="supportPhone" placeholder="+91XXXXXXXXXX" /></div>
      <div class="form-row"><label for="supportLink">Support Link</label><input id="supportLink" placeholder="https://example.com/support" /></div>
      <div class="form-row"><label for="address">Address</label><input id="address" placeholder="Street, City, State, ZIP" /></div>
      <div class="form-row"><label for="businessHours">Business Hours</label><input id="businessHours" placeholder="Mon-Fri 9am-6pm IST" /></div>
      <div class="form-row"><label for="tone">Tone</label><input id="tone" placeholder="friendly and professional" /></div>
      <div class="form-row"><label for="traits">Traits (comma-separated)</label><input id="traits" placeholder="helpful, empathetic, solution-oriented" /></div>
      <div class="form-row"><button class="btn success" onclick="savePersonality()">Save Personality & Brand</button></div>
      <div id="brandSaveStatus" class="alert info" style="display:none"></div>
    </div>

    <!-- FAQ Preview -->
    <div class="section">
      <h2>üß™ FAQ Preview</h2>
      <div id="faqPreview" class="preview-card" style="border:1px solid #e2e8f0; border-radius:12px; padding:1rem; background:#f9fafb">
        <div class="preview-line"><strong>Q:</strong> What is your company name?<br><strong>A:</strong> <span id="pv_company">‚Äî</span></div>
        <div class="preview-line" style="margin-top:0.5rem"><strong>Q:</strong> What‚Äôs your website?<br><strong>A:</strong> <span id="pv_website">‚Äî</span></div>
        <div class="preview-line" style="margin-top:0.5rem"><strong>Q:</strong> How can I contact support?<br><strong>A:</strong> Phone: <span id="pv_phone">‚Äî</span>, Email: <span id="pv_email">‚Äî</span></div>
        <div class="preview-line" style="margin-top:0.5rem"><strong>Q:</strong> What are your business hours?<br><strong>A:</strong> <span id="pv_hours">‚Äî</span></div>
        <div class="preview-line" style="margin-top:0.5rem"><strong>Q:</strong> What‚Äôs your address?<br><strong>A:</strong> <span id="pv_address">‚Äî</span></div>
        <div class="preview-actions" style="margin-top:0.75rem">
          <button class="btn" onclick="updateFAQPreview()">Refresh Preview</button>
        </div>
      </div>
    </div>

    <!-- FAQ Templates Editing -->
    <div class="section">
      <h2>üìù FAQ Templates</h2>
      <div class="alert info">Customize the exact sentences the bot will use. Leave blank to auto-fill from Brand Details.</div>
      <div class="form-row"><label for="faq_companyName">A: Company Name</label><textarea id="faq_companyName" placeholder="e.g., Our company name is SYNTHCORE."></textarea></div>
      <div class="form-row"><label for="faq_website">A: Website</label><textarea id="faq_website" placeholder="e.g., You can visit us at https://api.synthcore.in."></textarea></div>
      <div class="form-row"><label for="faq_contactSupport">A: Contact Support</label><textarea id="faq_contactSupport" placeholder="e.g., Reach us at +91XXXXXXXXXX or email support@example.com."></textarea></div>
      <div class="form-row"><label for="faq_businessHours">A: Business Hours</label><textarea id="faq_businessHours" placeholder="e.g., Mon‚ÄìFri, 9am‚Äì6pm IST."></textarea></div>
      <div class="form-row"><label for="faq_address">A: Address</label><textarea id="faq_address" placeholder="e.g., Street, City, State, ZIP."></textarea></div>
      <div class="form-row"><button class="btn success" onclick="saveFAQTemplates()">Save FAQ Templates</button></div>
      <div id="faqSaveStatus" class="alert info" style="display:none"></div>
    </div>

    <!-- Knowledge Base Management -->
    <div class="section">
      <h2>üìö Knowledge Base</h2>
      <div class="alert info">Upload files or add text to train the AI about your company. For advanced retrieval, use the RAG Dashboard.</div>
      <div class="form-row"><label>Files (PDF/TXT/MD)</label><input id="kbFiles" type="file" multiple /></div>
      <div class="form-row"><label for="kbCategory">Category</label><input id="kbCategory" placeholder="e.g., general, products, faq" /></div>
      <div class="form-row"><label for="kbDescription">Description</label><input id="kbDescription" placeholder="Short note about these files" /></div>
      <div class="form-row"><button class="btn" onclick="uploadKnowledgeFiles()">Upload Files</button></div>
      <div id="kbUploadStatus" class="alert info" style="display:none"></div>

      <div style="margin: 1rem 0; border-top:1px solid #e2e8f0"></div>

      <h3 style="font-size:1rem; margin-bottom:0.5rem; color:#1e293b">Train from Website URL</h3>
      <div class="form-row"><label for="kbWebsiteUrl">Website URL</label><input id="kbWebsiteUrl" placeholder="https://www.example.com/about" /></div>
      <div class="form-row"><label for="kbWebsiteCategory">Category</label><input id="kbWebsiteCategory" placeholder="e.g., website, products, docs" /></div>
      <div class="form-row"><label for="kbWebsiteDescription">Description</label><input id="kbWebsiteDescription" placeholder="Short context for this scrape" /></div>
      <div class="form-row"><button class="btn" onclick="trainWebsite()">Train from Website</button></div>
      <div id="kbWebsiteStatus" class="alert info" style="display:none"></div>

      <div style="margin: 1rem 0; border-top:1px solid #e2e8f0"></div>

      <div class="form-row"><label for="kbTextSource">Source/Title</label><input id="kbTextSource" placeholder="e.g., Website About Us" /></div>
      <div class="form-row"><label for="kbTextType">Type/Category</label><input id="kbTextType" placeholder="e.g., manual, faq, policy" /></div>
      <div class="form-row"><label for="kbTextContent">Content</label><textarea id="kbTextContent" placeholder="Paste text content to add to knowledge base"></textarea></div>
      <div class="form-row"><button class="btn success" onclick="uploadKnowledgeText()">Add Text to Knowledge</button></div>
      <div id="kbTextStatus" class="alert info" style="display:none"></div>

      <div style="margin: 1rem 0; border-top:1px solid #e2e8f0"></div>

      <h3 style="font-size:1rem; margin-bottom:0.5rem; color:#1e293b">Knowledge Items</h3>
      <div id="kbList" style="background:#f9fafb; border:1px solid #e2e8f0; border-radius:8px; padding:0.75rem"></div>
    </div>
  </main>

  <script>
    let aiEnabled = true;

    // AI Toggle Functions
    function toggleAI() {
      aiEnabled = !aiEnabled;
      updateAIToggleUI();
      saveAIState();
    }

    function updateAIToggleUI() {
      const toggle = document.getElementById('aiToggle');
      const status = document.getElementById('aiStatus');
      
      if (aiEnabled) {
        toggle.classList.add('active');
        status.textContent = 'AI is Active';
        status.className = 'status-text active';
      } else {
        toggle.classList.remove('active');
        status.textContent = 'AI is Disabled';
        status.className = 'status-text inactive';
      }
    }

    async function saveAIState() {
      try {
        const response = await fetch('/api/ai/toggle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled: aiEnabled })
        });
        const data = await response.json();
        if (data.success) {
          setStatus('aiToggleStatus', `AI ${aiEnabled ? 'enabled' : 'disabled'} successfully`, 'success');
        } else {
          setStatus('aiToggleStatus', 'Error saving AI state', 'error');
        }
      } catch (error) {
        setStatus('aiToggleStatus', 'Error saving AI state', 'error');
      }
    }

    // Handoff/Business Hours UI and logic removed

    // Utility Functions
    function setStatus(id, msg, type) {
      const el = document.getElementById(id);
      el.style.display = 'block';
      el.className = `alert ${type}`;
      el.textContent = msg;
      
      // Auto-hide after 3 seconds
      setTimeout(() => {
        el.style.display = 'none';
      }, 3000);
    }

    function val(id) { 
      return document.getElementById(id).value; 
    }

    async function loadPersonality() {
      try {
        const res = await fetch('/api/ai/personality');
        const data = await res.json();
        if (data && data.success && data.personality) {
          aiEnabled = !!data.personality.aiEnabled;
          updateAIToggleUI();
          // Populate brand fields
          setVal('name', data.personality.name || '');
          setVal('role', data.personality.role || '');
          setVal('company', data.personality.company || '');
          setVal('website', data.personality.website || '');
          setVal('supportEmail', data.personality.supportEmail || '');
          setVal('supportPhone', data.personality.supportPhone || '');
          setVal('supportLink', data.personality.supportLink || '');
          setVal('address', data.personality.address || '');
          setVal('businessHours', data.personality.businessHours || '');
          setVal('tone', data.personality.tone || '');
          setVal('traits', Array.isArray(data.personality.traits) ? data.personality.traits.join(', ') : '');
          // Populate FAQ templates
          const ft = data.personality.faqTemplates || {};
          setVal('faq_companyName', ft.companyName || '');
          setVal('faq_website', ft.website || '');
          setVal('faq_contactSupport', ft.contactSupport || '');
          setVal('faq_businessHours', ft.businessHours || '');
          setVal('faq_address', ft.address || '');
        }
      } catch (_) {
        // keep defaults
        updateAIToggleUI();
      }
    }


    function setVal(id, v) {
      const el = document.getElementById(id);
      if (el) el.value = v || '';
    }

    function setText(id, v) {
      const el = document.getElementById(id);
      if (el) el.textContent = v && String(v).trim().length ? v : '‚Äî';
    }

    function updateFAQPreview() {
      // Prefer FAQ templates; fallback to Brand Details
      const companyTpl = val('faq_companyName');
      const websiteTpl = val('faq_website');
      const contactTpl = val('faq_contactSupport');
      const hoursTpl = val('faq_businessHours');
      const addressTpl = val('faq_address');

      const company = companyTpl || val('company');
      const website = websiteTpl || val('website');
      const phone = contactTpl ? contactTpl : val('supportPhone');
      const email = contactTpl ? '' : val('supportEmail');
      const hours = hoursTpl || val('businessHours');
      const address = addressTpl || val('address');

      setText('pv_company', company);
      setText('pv_website', website);
      // If contactTpl is present, render it as a single sentence; else show Phone/Email fields
      if (contactTpl) {
        setText('pv_phone', contactTpl);
        setText('pv_email', '');
      } else {
        setText('pv_phone', phone);
        setText('pv_email', email);
      }
      setText('pv_hours', hours);
      setText('pv_address', address);
    }

    async function savePersonality() {
      try {
        const payload = {
          name: val('name'),
          role: val('role'),
          company: val('company'),
          tone: val('tone'),
          traits: val('traits').split(',').map(s => s.trim()).filter(Boolean),
          website: val('website'),
          supportEmail: val('supportEmail'),
          supportPhone: val('supportPhone'),
          supportLink: val('supportLink'),
          address: val('address'),
          businessHours: val('businessHours')
        };
        const res = await fetch('/api/ai/personality', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data && data.success) {
          setStatus('brandSaveStatus', 'Personality & Brand saved successfully', 'success');
          updateFAQPreview();
        } else {
          setStatus('brandSaveStatus', 'Error saving Personality & Brand', 'error');
        }
      } catch (e) {
        setStatus('brandSaveStatus', 'Error saving Personality & Brand', 'error');
      }
    }

    async function saveFAQTemplates() {
      try {
        const faqTemplates = {
          companyName: val('faq_companyName'),
          website: val('faq_website'),
          contactSupport: val('faq_contactSupport'),
          businessHours: val('faq_businessHours'),
          address: val('faq_address')
        };
        const res = await fetch('/api/ai/personality', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ faqTemplates })
        });
        const data = await res.json();
        if (data && data.success) {
          setStatus('faqSaveStatus', 'FAQ templates saved successfully', 'success');
          updateFAQPreview();
        } else {
          setStatus('faqSaveStatus', 'Error saving FAQ templates', 'error');
        }
      } catch (e) {
        setStatus('faqSaveStatus', 'Error saving FAQ templates', 'error');
      }
    }

    // Initialize
    loadPersonality().then(updateFAQPreview).then(loadKnowledgeList);

    // Live update preview when editing fields
    ['company','website','supportPhone','supportEmail','businessHours','address'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', updateFAQPreview);
    });
    ['faq_companyName','faq_website','faq_contactSupport','faq_businessHours','faq_address'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', updateFAQPreview);
    });

    async function uploadKnowledgeFiles() {
      try {
        const input = document.getElementById('kbFiles');
        const files = input.files;
        if (!files || files.length === 0) {
          setStatus('kbUploadStatus', 'Please select files to upload', 'error');
          return;
        }
        const fd = new FormData();
        for (let i = 0; i < files.length; i++) fd.append('files', files[i]);
        fd.append('category', document.getElementById('kbCategory').value || 'general');
        fd.append('description', document.getElementById('kbDescription').value || '');
        const res = await fetch('/api/ai/knowledge/upload', { method: 'POST', body: fd });
        const data = await res.json();
        if (data && data.success) {
          setStatus('kbUploadStatus', `Uploaded ${data.uploadedCount || 0} of ${data.totalFiles || files.length} files`, 'success');
          await loadKnowledgeList();
        } else {
          setStatus('kbUploadStatus', data.error || 'Upload failed', 'error');
        }
      } catch (e) {
        setStatus('kbUploadStatus', 'Upload failed', 'error');
      }
    }

    async function uploadKnowledgeText() {
      try {
        const payload = {
          content: document.getElementById('kbTextContent').value || '',
          source: document.getElementById('kbTextSource').value || 'API Upload',
          type: document.getElementById('kbTextType').value || 'manual'
        };
        if (!payload.content.trim()) {
          setStatus('kbTextStatus', 'Content is required', 'error');
          return;
        }
        const res = await fetch('/api/knowledge/upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data && data.success) {
          setStatus('kbTextStatus', 'Knowledge text added', 'success');
          document.getElementById('kbTextContent').value = '';
          await loadKnowledgeList();
        } else {
          setStatus('kbTextStatus', data.error || 'Failed to add text', 'error');
        }
      } catch (e) {
        setStatus('kbTextStatus', 'Failed to add text', 'error');
      }
    }

    async function trainWebsite() {
      try {
        const websiteUrl = document.getElementById('kbWebsiteUrl').value || '';
        if (!websiteUrl.trim()) {
          setStatus('kbWebsiteStatus', 'Website URL is required', 'error');
          return;
        }
        const payload = {
          websiteUrl,
          description: document.getElementById('kbWebsiteDescription').value || '',
          category: document.getElementById('kbWebsiteCategory').value || 'website'
        };
        const res = await fetch('/api/ai/train-website', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data && data.success) {
          setStatus('kbWebsiteStatus', 'Website content added to knowledge base', 'success');
          await loadKnowledgeList();
        } else {
          setStatus('kbWebsiteStatus', data.error || 'Website training failed', 'error');
        }
      } catch (e) {
        setStatus('kbWebsiteStatus', 'Website training failed', 'error');
      }
    }

    async function loadKnowledgeList() {
      try {
        const res = await fetch('/api/ai/knowledge');
        const data = await res.json();
        const list = document.getElementById('kbList');
        if (!data || !data.success) {
          list.textContent = 'Failed to load knowledge list';
          return;
        }
        if (!data.knowledge || data.knowledge.length === 0) {
          list.textContent = 'No knowledge items yet. Upload files or add text above.';
          return;
        }
        list.innerHTML = data.knowledge.map(item => {
          const date = item.uploadedAt ? new Date(item.uploadedAt).toLocaleString() : '';
          const sizeMb = item.size ? (item.size / 1024 / 1024).toFixed(2) + ' MB' : '';
          return `<div style="padding:8px; border-bottom:1px solid #e2e8f0">
            <div style="font-weight:600">${item.filename}</div>
            <div style="color:#64748b; font-size:0.9rem">${item.category || 'general'} ¬∑ ${date} ¬∑ ${sizeMb}</div>
            <div style="color:#475569; font-size:0.9rem">${item.description || ''}</div>
          </div>`;
        }).join('');
      } catch (e) {
        const list = document.getElementById('kbList');
        list.textContent = 'Failed to load knowledge list';
      }
    }
  </script>
</body>
</html>