<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GHL OAuth Status</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .card { margin: 20px auto; max-width: 900px; border-radius: 12px; }
    .token-box { background: #f8f9fa; border-radius: 8px; padding: 12px; word-break: break-all; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#e9ecef; margin-right:6px; font-size:12px; }
  </style>
  </head>
<body>
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4 class="mb-0">GoHighLevel OAuth Status</h4>
      <div>
        <a class="btn btn-outline-secondary btn-sm" href="/index.html">Dashboard</a>
        <button class="btn btn-primary btn-sm" onclick="openAuthorize()">Connect GHL</button>
      </div>
    </div>
    <div class="card-body">
      <div id="statusRow" class="mb-3"></div>
      <div id="locations"></div>
    </div>
  </div>

  <script>
    async function loadStatus() {
      const r = await fetch('/api/oauth/status');
      const j = await r.json();
      if (!j.success) { document.getElementById('statusRow').innerHTML = '<div class="alert alert-danger">Failed to load status</div>'; return; }
      const s = j.status || {};
      const pills = [
        `<span class='pill'>configured: ${s.configured ? 'yes' : 'no'}</span>`,
        `<span class='pill'>clientId: ${s.clientId || '-'}</span>`,
        `<span class='pill'>redirect: ${s.redirectUri || '-'}</span>`
      ].join(' ');
      const scopes = Array.isArray(s.scopes) ? s.scopes.join(', ') : '';
      document.getElementById('statusRow').innerHTML = `
        <div class='mb-2'>${pills}</div>
        <div><strong>Scopes:</strong> ${scopes || '-'}</div>
      `;

      const locs = Array.isArray(s.locations) ? s.locations : [];
      if (locs.length === 0) { document.getElementById('locations').innerHTML = '<div class="alert alert-info">No locations with stored tokens yet.</div>'; return; }
      document.getElementById('locations').innerHTML = locs.map(l => `
        <div class='mb-3 p-3 border rounded'>
          <div><strong>Location:</strong> ${l.locationId}</div>
          <div><strong>Has Access Token:</strong> ${l.hasAccessToken ? 'yes' : 'no'}</div>
          <div><strong>Obtained:</strong> ${l.obtainedAt ? new Date(l.obtainedAt).toLocaleString() : '-'}</div>
          <div><strong>Expires In:</strong> ${l.expiresIn ?? '-'}</div>
          <div class='mt-2'><button class='btn btn-sm btn-outline-primary' onclick="viewToken('${l.locationId}')">View Token</button></div>
        </div>
      `).join('');
    }

    async function viewToken(locationId) {
      const r = await fetch(`/api/oauth/token?locationId=${encodeURIComponent(locationId)}`);
      const j = await r.json();
      if (!j.success) { alert('Failed to fetch token'); return; }
      const t = j.token || {};
      const html = `
        <div><strong>locationId:</strong> ${t.locationId || '-'}</div>
        <div class='token-box mt-2'><strong>access_token</strong><br>${t.access_token || '-'}</div>
        <div class='token-box mt-2'><strong>refresh_token</strong><br>${t.refresh_token || '-'}</div>
        <div class='mt-2'><strong>token_type:</strong> ${t.token_type || '-'}</div>
        <div class='mt-2'><strong>expires_in:</strong> ${t.expires_in ?? '-'}</div>
      `;
      const w = window.open('', '_blank');
      w.document.write(`<html><head><title>Token ${t.locationId}</title></head><body>${html}</body></html>`);
      w.document.close();
    }

    async function openAuthorize() {
      try {
        const r = await fetch('/api/oauth/authorize');
        const j = await r.json();
        if (j && j.authorizeUrl) { window.open(j.authorizeUrl, '_blank'); return; }
        const r2 = await fetch('/api/oauth/authorize?version_id=692dde2c13a71a9413fae79f');
        const j2 = await r2.json();
        if (j2 && j2.authorizeUrl) { window.open(j2.authorizeUrl, '_blank'); return; }
        alert('Authorize URL not available');
      } catch (e) { alert('Error: ' + e.message); }
    }

    loadStatus();
  </script>
</body>
</html>
