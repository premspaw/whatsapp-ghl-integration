<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Integration - WhatsApp-GHL Manager</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .page-header {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin: 20px;
            padding: 30px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 500;
        }

        .status-badge.connected {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .content-container {
            margin: 20px;
        }

        .content-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            padding: 30px;
            margin-bottom: 20px;
        }

        .content-card h4 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .info-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            color: #333;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stat-box h3 {
            font-size: 2.5rem;
            margin-bottom: 5px;
        }

        .stat-box p {
            margin: 0;
            opacity: 0.9;
        }

        .log-entry {
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .log-entry.error {
            border-left-color: #dc3545;
        }

        .log-entry.success {
            border-left-color: #28a745;
        }

        .log-entry .log-time {
            font-size: 12px;
            color: #666;
        }

        .tab-content {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <h2 id="integrationTitle"><i class="fab fa-whatsapp text-success"></i> Loading...</h2>
                <p class="text-muted mb-0" id="integrationSubtitle">Please wait...</p>
            </div>
            <span id="statusBadge" class="status-badge disconnected">
                <i class="fas fa-circle"></i> Disconnected
            </span>
        </div>

        <div class="action-buttons">
            <button class="btn btn-outline-secondary" onclick="window.location.href='index.html'">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </button>
            <button class="btn btn-primary" onclick="viewConversations()">
                <i class="fas fa-comments"></i> View Conversations
            </button>
            <button class="btn btn-info" onclick="testIntegration()">
                <i class="fas fa-vial"></i> Test Connection
            </button>
            <button class="btn btn-success" id="btnConnect" onclick="connectIntegration()" style="display:none;">
                <i class="fas fa-link"></i> Connect
            </button>
            <button class="btn btn-success" onclick="connectGHL()">
                <i class="fas fa-plug"></i> Connect GHL (OAuth)
            </button>
            <button class="btn btn-warning" id="btnDisconnect" onclick="disconnectIntegration()" style="display:none;">
                <i class="fas fa-unlink"></i> Disconnect
            </button>
            <button class="btn btn-danger" onclick="deleteIntegration()">
                <i class="fas fa-trash"></i> Delete Integration
            </button>
        </div>
    </div>

    <!-- Content Container -->
    <div class="content-container">
        <!-- Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-box">
                    <h3 id="statMessages">0</h3>
                    <p>Messages Today</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <h3 id="statConversations">0</h3>
                    <p>Active Conversations</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <h3 id="statContacts">0</h3>
                    <p>Total Contacts</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <h3 id="statUptime">0%</h3>
                    <p>Uptime</p>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="manageTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button">
                    <i class="fas fa-info-circle"></i> Details
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="whatsapp-tab" data-bs-toggle="tab" data-bs-target="#whatsapp" type="button">
                    <i class="fab fa-whatsapp"></i> WhatsApp Settings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ghl-tab" data-bs-toggle="tab" data-bs-target="#ghl" type="button">
                    <i class="fas fa-database"></i> GHL Settings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai" type="button">
                    <i class="fas fa-brain"></i> AI Configuration
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button">
                    <i class="fas fa-list"></i> Activity Logs
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Details Tab -->
            <div class="tab-pane fade show active" id="details">
                <div class="content-card">
                    <h4><i class="fas fa-info-circle"></i> Integration Details</h4>
                    
                    <div class="info-row">
                        <div class="info-item">
                            <div class="info-label">Integration ID</div>
                            <div class="info-value" id="detailId">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Name</div>
                            <div class="info-value" id="detailName">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Status</div>
                            <div class="info-value" id="detailStatus">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Created On</div>
                            <div class="info-value" id="detailCreated">-</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>Description</strong></label>
                        <p id="detailDescription" class="text-muted">No description provided</p>
                    </div>

                    <button class="btn btn-primary" onclick="editIntegrationInfo()">
                        <i class="fas fa-edit"></i> Edit Information
                    </button>
                </div>
            </div>

            <!-- WhatsApp Tab -->
            <div class="tab-pane fade" id="whatsapp">
                <div class="content-card">
                    <h4><i class="fab fa-whatsapp"></i> WhatsApp Configuration</h4>
                    
                    <div class="info-row">
                        <div class="info-item">
                            <div class="info-label">Connection Type</div>
                            <div class="info-value" id="whatsappType">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">WhatsApp Number</div>
                            <div class="info-value" id="whatsappNumber">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Business Name</div>
                            <div class="info-value" id="whatsappBusinessName">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Connection Status</div>
                            <div class="info-value" id="whatsappConnectionStatus">-</div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Important:</strong> Changing WhatsApp settings may disconnect your current connection.
                    </div>

                    <button class="btn btn-warning" onclick="reconnectWhatsApp()">
                        <i class="fas fa-sync"></i> Reconnect WhatsApp
                    </button>
                </div>
            </div>

            <!-- GHL Tab -->
            <div class="tab-pane fade" id="ghl">
                <div class="content-card">
                    <h4><i class="fas fa-database"></i> GoHighLevel Configuration</h4>
                    
                    <div class="info-row">
                        <div class="info-item">
                            <div class="info-label">Location ID</div>
                            <div class="info-value" id="ghlLocationId">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Location Name</div>
                            <div class="info-value" id="ghlLocationName">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">API Status</div>
                            <div class="info-value" id="ghlApiStatus">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Sync Status</div>
                            <div class="info-value" id="ghlSyncStatus">-</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>API Key</strong></label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="ghlApiKey" value="••••••••••••" readonly>
                            <button class="btn btn-outline-secondary" onclick="toggleApiKey()">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="testGHLConnection()">
                        <i class="fas fa-vial"></i> Test GHL Connection
                    </button>
                    <button class="btn btn-info" onclick="syncWithGHL()">
                        <i class="fas fa-sync"></i> Force Sync
                    </button>
                </div>
            </div>

            <!-- AI Tab -->
            <div class="tab-pane fade" id="ai">
                <div class="content-card">
                    <h4><i class="fas fa-brain"></i> AI Configuration</h4>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="aiEnabled" onchange="toggleAI()">
                        <label class="form-check-label" for="aiEnabled">
                            <strong>Enable AI Auto-Reply</strong>
                        </label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>AI Model</strong></label>
                        <select class="form-select" id="aiModel">
                            <option value="gpt-4">GPT-4 (Recommended)</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Faster)</option>
                            <option value="claude-3">Claude 3</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>System Prompt</strong></label>
                        <textarea class="form-control" id="aiSystemPrompt" rows="5" 
                                  placeholder="You are a helpful AI assistant..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>Response Temperature</strong> (0-1)</label>
                        <input type="range" class="form-range" id="aiTemperature" min="0" max="1" step="0.1" value="0.7">
                        <small class="form-text text-muted">Current: <span id="tempValue">0.7</span></small>
                    </div>

                    <button class="btn btn-primary" onclick="saveAISettings()">
                        <i class="fas fa-save"></i> Save AI Settings
                    </button>
                    
                </div>
            </div>

            <!-- Logs Tab -->
            <div class="tab-pane fade" id="logs">
                <div class="content-card">
                    <h4><i class="fas fa-list"></i> Activity Logs</h4>
                    
                    <div class="mb-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="filterLogs('all')">All</button>
                        <button class="btn btn-sm btn-outline-success" onclick="filterLogs('success')">Success</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="filterLogs('error')">Errors</button>
                        <button class="btn btn-sm btn-outline-info" onclick="filterLogs('sync')">Sync</button>
                    </div>

                    <div id="logsList">
                        <div class="log-entry success">
                            <div class="log-time">2 minutes ago</div>
                            <div><strong>Message Sent:</strong> Successfully sent message to +1234567890</div>
                        </div>
                        <div class="log-entry">
                            <div class="log-time">10 minutes ago</div>
                            <div><strong>GHL Sync:</strong> Synced 5 new messages to GoHighLevel</div>
                        </div>
                        <div class="log-entry error">
                            <div class="log-time">1 hour ago</div>
                            <div><strong>Error:</strong> Failed to connect to WhatsApp API</div>
                        </div>
                    </div>

                    <button class="btn btn-outline-secondary btn-sm mt-3" onclick="refreshLogs()">
                        <i class="fas fa-sync"></i> Refresh Logs
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const socket = io();
        let integrationId = null;
        let integrationData = null;
        let integrationNotFound = false;

        // Get integration ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        integrationId = urlParams.get('id');

        if (!integrationId) {
            alert('No integration ID provided');
            window.location.href = 'index.html';
        }

        // Load integration data
        document.addEventListener('DOMContentLoaded', function() {
            loadIntegrationData();

            // Setup AI temperature slider
            document.getElementById('aiTemperature').addEventListener('input', function() {
                document.getElementById('tempValue').textContent = this.value;
            });

            // Real-time updates
            socket.on('integration_status_changed', function(data) {
                if (data.integrationId === integrationId) {
                    loadIntegrationData();
                }
            });
        });

        async function loadIntegrationData() {
            try {
                const response = await fetch(`/api/integrations/${integrationId}`);
                const data = await response.json();
                
                if (data.success) {
                    integrationData = data.integration;
                    renderIntegrationData();
                } else {
                    integrationNotFound = true;
                    showOAuthOnly();
                }
            } catch (error) {
                console.error('Error loading integration:', error);
                integrationNotFound = true;
                showOAuthOnly();
            }
        }

        function renderIntegrationData() {
            if (!integrationData) return;

            // Header
            document.getElementById('integrationTitle').innerHTML = 
                `<i class="fab fa-whatsapp text-success"></i> ${integrationData.name}`;
            document.getElementById('integrationSubtitle').textContent = 
                integrationData.description || 'No description provided';

            // Status badge
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.className = `status-badge ${integrationData.status || 'disconnected'}`;
            statusBadge.innerHTML = `<i class="fas fa-circle"></i> ${(integrationData.status || 'disconnected').toUpperCase()}`;

            // Show/hide connect/disconnect buttons
            if (integrationData.status === 'connected') {
                document.getElementById('btnConnect').style.display = 'none';
                document.getElementById('btnDisconnect').style.display = 'inline-block';
            } else {
                document.getElementById('btnConnect').style.display = 'inline-block';
                document.getElementById('btnDisconnect').style.display = 'none';
            }

            // Statistics
            document.getElementById('statMessages').textContent = integrationData.messagesToday || 0;
            document.getElementById('statConversations').textContent = integrationData.activeConversations || 0;
            document.getElementById('statContacts').textContent = integrationData.activeContacts || 0;
            document.getElementById('statUptime').textContent = (integrationData.uptime || 100) + '%';

            // Details tab
            document.getElementById('detailId').textContent = integrationData.id;
            document.getElementById('detailName').textContent = integrationData.name;
            document.getElementById('detailStatus').textContent = (integrationData.status || 'disconnected').toUpperCase();
            document.getElementById('detailCreated').textContent = new Date(integrationData.createdAt || Date.now()).toLocaleDateString();
            document.getElementById('detailDescription').textContent = integrationData.description || 'No description provided';

            // WhatsApp tab
            document.getElementById('whatsappType').textContent = 
                integrationData.connectionType === 'api' ? 'WhatsApp Business API' : 'Existing WhatsApp Business';
            document.getElementById('whatsappNumber').textContent = integrationData.whatsappNumber || '-';
            document.getElementById('whatsappBusinessName').textContent = integrationData.businessName || '-';
            document.getElementById('whatsappConnectionStatus').textContent = 
                integrationData.status === 'connected' ? 'Connected' : 'Disconnected';

            // GHL tab
            document.getElementById('ghlLocationId').textContent = integrationData.ghlLocationId || '-';
            document.getElementById('ghlLocationName').textContent = integrationData.ghlLocationName || '-';
            document.getElementById('ghlApiStatus').textContent = 'Connected';
            document.getElementById('ghlSyncStatus').textContent = 'Active';

            // AI tab
            document.getElementById('aiEnabled').checked = integrationData.aiEnabled !== false;
        }

        function viewConversations() {
            window.location.href = `ghl-whatsapp-tab.html?integration=${integrationId}`;
        }

        async function testIntegration() {
            try {
                const response = await fetch(`/api/integrations/${integrationId}/test`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('✅ Integration test successful!\n\n' + data.message);
                } else {
                    alert('❌ Integration test failed:\n\n' + data.error);
                }
            } catch (error) {
                alert('❌ Error testing integration: ' + error.message);
            }
        }

        async function connectIntegration() {
            try {
                const response = await fetch(`/api/integrations/${integrationId}/connect`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('✅ Integration connected successfully!');
                    loadIntegrationData();
                } else {
                    alert('❌ Failed to connect: ' + data.error);
                    if ((data.error || '').includes('Integration not found')) {
                        connectGHL();
                    }
                }
            } catch (error) {
                alert('❌ Error connecting: ' + error.message);
            }
        }

        async function connectGHL() {
            try {
                const r = await fetch('/api/oauth/authorize');
                const j = await r.json();
                const url = j && j.authorizeUrl ? j.authorizeUrl : '';
                if (url) {
                    window.open(url, '_blank');
                    return;
                }
                const r2 = await fetch('/api/oauth/authorize?version_id=692dde2c13a71a9413fae79f');
                const j2 = await r2.json();
                if (j2 && j2.authorizeUrl) {
                    window.open(j2.authorizeUrl, '_blank');
                    return;
                }
                alert('Authorize URL not available');
            } catch (e) {
                alert('Error opening authorize: ' + e.message);
            }
        }

        async function disconnectIntegration() {
            if (!confirm('Are you sure you want to disconnect this integration?')) {
                return;
            }

            try {
                const response = await fetch(`/api/integrations/${integrationId}/disconnect`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('✅ Integration disconnected');
                    loadIntegrationData();
                } else {
                    alert('❌ Failed to disconnect: ' + data.error);
                }
            } catch (error) {
                alert('❌ Error disconnecting: ' + error.message);
            }
        }

        async function deleteIntegration() {
            if (!confirm('⚠️ Are you sure you want to DELETE this integration? This cannot be undone!')) {
                return;
            }

            try {
                const response = await fetch(`/api/integrations/${integrationId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('✅ Integration deleted');
                    window.location.href = 'index.html';
                } else {
                    alert('❌ Failed to delete: ' + data.error);
                }
            } catch (error) {
                alert('❌ Error deleting: ' + error.message);
            }
        }

        function showOAuthOnly() {
            try {
                document.getElementById('integrationTitle').innerHTML = `<i class="fab fa-whatsapp text-success"></i> GHL Authorization Needed`;
                document.getElementById('integrationSubtitle').textContent = 'This local integration ID was not found. Use Connect GHL (OAuth) to authorize your Location.';
                const btnConnect = document.getElementById('btnConnect');
                const btnDisconnect = document.getElementById('btnDisconnect');
                if (btnConnect) btnConnect.style.display = 'none';
                if (btnDisconnect) btnDisconnect.style.display = 'none';
            } catch (_) {}
        }

        function editIntegrationInfo() {
            alert('Edit functionality coming soon!');
        }

        function reconnectWhatsApp() {
            alert('Reconnect functionality coming soon!');
        }

        function testGHLConnection() {
            alert('Testing GHL connection...');
        }

        function syncWithGHL() {
            alert('Syncing with GHL...');
        }

        function toggleAI() {
            const enabled = document.getElementById('aiEnabled').checked;
            alert(`AI Auto-Reply ${enabled ? 'enabled' : 'disabled'}`);
        }

        function saveAISettings() {
            alert('AI settings saved!');
        }

        function toggleApiKey() {
            const input = document.getElementById('ghlApiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function filterLogs(type) {
            alert(`Filtering logs by: ${type}`);
        }

        function refreshLogs() {
            alert('Refreshing logs...');
        }
    </script>
</body>
</html>

